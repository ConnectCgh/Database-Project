<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å®¶ä¸­å¿ƒ - SpeedEats</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
        }

        body {
            background-color: #0d1117;
            color: #c9d1d9;
            min-height: 100vh;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* ä¾§è¾¹æ æ ·å¼ */
        .sidebar {
            width: 250px;
            background-color: #161b22;
            border-right: 1px solid #21262d;
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .logo {
            padding: 0 20px 20px;
            border-bottom: 1px solid #21262d;
            margin-bottom: 20px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #ffc107, #ff9800);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            position: relative;
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
        }

        .logo-icon::before {
            content: "ğŸ”";
            font-size: 24px;
            filter: grayscale(1) brightness(0.2);
        }

        .logo-text {
            color: #ffc107;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            letter-spacing: 1px;
        }

        .merchant-info {
            padding: 0 20px 20px;
            border-bottom: 1px solid #21262d;
            margin-bottom: 20px;
        }

        .merchant-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .merchant-status {
            font-size: 12px;
            color: #8b949e;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 5px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: #c9d1d9;
            text-decoration: none;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .nav-link:hover {
            background-color: rgba(255, 193, 7, 0.1);
            color: #ffc107;
        }

        .nav-link.active {
            background-color: rgba(255, 193, 7, 0.1);
            color: #ffc107;
            border-left-color: #ffc107;
        }

        .nav-icon {
            margin-right: 10px;
            font-size: 18px;
        }

        /* ä¸»å†…å®¹åŒºæ ·å¼ */
        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #21262d;
        }

        .page-title {
            font-size: 24px;
            font-weight: 300;
            color: #f0f6fc;
        }

        .user-menu {
            display: flex;
            align-items: center;
        }

        .user-name {
            margin-right: 15px;
        }

        .logout-btn {
            background-color: transparent;
            border: 1px solid #30363d;
            color: #c9d1d9;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background-color: rgba(248, 81, 73, 0.1);
            border-color: #f85149;
            color: #f85149;
        }

        /* å†…å®¹å¡ç‰‡æ ·å¼ */
        .content-card {
            background-color: #161b22;
            border: 1px solid #21262d;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #21262d;
        }

        .card-title {
            font-size: 18px;
            font-weight: 500;
            color: #f0f6fc;
        }

        .btn {
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            background-color: #ffc107;
            color: #0d1117;
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            background-color: #ffca2c;
            box-shadow: 0 0 8px rgba(255, 193, 7, 0.4);
        }

        .btn-secondary {
            background-color: #21262d;
            color: #c9d1d9;
            border-color: #30363d;
        }

        .btn-secondary:hover {
            background-color: #30363d;
            box-shadow: 0 0 8px rgba(48, 54, 61, 0.4);
        }

        /* è¡¨æ ¼æ ·å¼ */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #21262d;
        }

        th {
            background-color: rgba(255, 193, 7, 0.1);
            color: #ffc107;
            font-weight: 500;
        }

        tr:hover {
            background-color: rgba(255, 193, 7, 0.05);
        }

        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 400;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 8px 12px;
            font-size: 14px;
            line-height: 20px;
            color: #c9d1d9;
            background-color: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            outline: none;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            border-color: #ffc107;
            box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.3);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        /* çŠ¶æ€æ ‡ç­¾ */
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-unassigned {
            background-color: rgba(248, 81, 73, 0.1);
            color: #f85149;
        }

        .status-assigned {
            background-color: rgba(45, 164, 255, 0.1);
            color: #2da4ff;
        }

        .status-ready {
            background-color: rgba(63, 185, 80, 0.1);
            color: #3fb950;
        }

        .status-completed {
            background-color: rgba(56, 139, 253, 0.1);
            color: #388bfd;
        }

        .status-cancelled {
            background-color: rgba(139, 148, 158, 0.1);
            color: #8b949e;
        }

        /* å¹³å°å¡ç‰‡ */
        .platform-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 16px;
        }

        .platform-card {
            background-color: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 16px;
            transition: all 0.2s;
        }

        .platform-card:hover {
            border-color: #ffc107;
        }

        .platform-card.joined {
            border-color: #3fb950;
        }

        .platform-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .platform-name {
            font-weight: 500;
            color: #f0f6fc;
        }

        .platform-status {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 10px;
        }

        .platform-status.joined {
            background-color: rgba(63, 185, 80, 0.1);
            color: #3fb950;
        }

        .platform-status.not-joined {
            background-color: rgba(139, 148, 158, 0.1);
            color: #8b949e;
        }

        .platform-phone {
            font-size: 12px;
            color: #8b949e;
            margin-bottom: 10px;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(13, 17, 23, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #161b22;
            border: 1px solid #21262d;
            border-radius: 6px;
            width: 90%;
            max-width: 500px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #21262d;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 500;
            color: #f0f6fc;
        }

        .close-btn {
            background: none;
            border: none;
            color: #8b949e;
            font-size: 20px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .close-btn:hover {
            color: #f0f6fc;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 10px;
            border-top: 1px solid #21262d;
        }

        .platform-status.applied {
            background-color: rgba(255, 193, 7, 0.1);
            color: #ffc107;
        }

        .platform-card.applied {
            border-color: #ffc107;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }

            .sidebar .logo-text,
            .sidebar .merchant-name,
            .sidebar .merchant-status,
            .sidebar .nav-link span {
                display: none;
            }

            .sidebar .logo {
                padding: 0 10px 20px;
            }

            .sidebar .nav-link {
                justify-content: center;
                padding: 12px 10px;
            }

            .sidebar .nav-icon {
                margin-right: 0;
            }

            .main-content {
                margin-left: 70px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }

        /* ç­›é€‰æŒ‰é’®ç»„ */
        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-buttons .btn.active {
            background-color: #ffc107;
            color: #0d1117;
        }

        /* è®¢å•æ“ä½œæŒ‰é’® */
        .order-actions {
            display: flex;
            gap: 5px;
        }

        .order-actions .btn {
            padding: 4px 8px;
            font-size: 12px;
        }

        .delete-order-btn {
            background-color: rgba(248, 81, 73, 0.1);
            color: #f85149;
            border-color: #f85149;
        }

        .delete-order-btn:hover {
            background-color: rgba(248, 81, 73, 0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar">
            <div class="logo">
                <div class="logo-icon"></div>
                <div class="logo-text">SpeedEats</div>
            </div>

            <div class="merchant-info">
                <div class="merchant-name">{{ merchant_name }}</div>
                <div class="merchant-status">å•†å®¶çŠ¶æ€ï¼šæ­£å¸¸</div>
            </div>

            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#" class="nav-link active" data-target="platform-section">
                        <span class="nav-icon">ğŸª</span>
                        <span>å…¥é©»å¹³å°</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-target="meal-section">
                        <span class="nav-icon">ğŸ”</span>
                        <span>ç®¡ç†é¤å“</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-target="discount-section">
                        <span class="nav-icon">ğŸ’°</span>
                        <span>ç®¡ç†æŠ˜æ‰£</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-target="order-section">
                        <span class="nav-icon">ğŸ“¦</span>
                        <span>ç®¡ç†è®¢å•</span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <div class="header">
                <h1 class="page-title">å•†å®¶ç®¡ç†ä¸­å¿ƒ</h1>
                <div class="user-menu">
                    <span class="user-name">{{ merchant_name }}</span>
                    <button class="logout-btn">é€€å‡ºç™»å½•</button>
                </div>
            </div>

            <!-- å…¥é©»å¹³å°éƒ¨åˆ† -->
            <div id="platform-section" class="content-section">
                <div class="content-card">
                    <div class="card-header">
                        <h2 class="card-title">å…¥é©»å¹³å°</h2>
                    </div>

                    <div class="platform-cards">
                       <!-- å·²å…¥é©»å¹³å° -->
                        {% for platform in joined_platforms %}
                        <div class="platform-card joined">
                            <div class="platform-header">
                                <div class="platform-name">{{ platform.platform_name }}</div>
                                <div class="platform-status joined">å·²å…¥é©»</div>
                            </div>
                            <div class="platform-phone">ç”µè¯: {{ platform.phone }}</div>
                            <button class="btn btn-secondary" style="width: 100%;">æŸ¥çœ‹è¯¦æƒ…</button>
                        </div>
                        {% endfor %}

                        <!-- å·²ç”³è¯·å¹³å° -->
                        {% for platform in applied_platforms %}
                        <div class="platform-card applied">
                            <div class="platform-header">
                                <div class="platform-name">{{ platform.platform_name }}</div>
                                <div class="platform-status applied">å®¡æ ¸ä¸­</div>
                            </div>
                            <div class="platform-phone">ç”µè¯: {{ platform.phone }}</div>
                            <button class="btn btn-secondary" style="width: 100%;" disabled>å®¡æ ¸ä¸­</button>
                        </div>
                        {% endfor %}

                        <!-- æœªç”³è¯·å¹³å° -->
                        {% for platform in not_joined_platforms %}
                        <div class="platform-card">
                            <div class="platform-header">
                                <div class="platform-name">{{ platform.platform_name }}</div>
                                <div class="platform-status not-joined">æœªå…¥é©»</div>
                            </div>
                            <div class="platform-phone">ç”µè¯: {{ platform.phone }}</div>
                            <button class="btn join-platform-btn" style="width: 100%;" data-platform-id="{{ platform.id }}">
                                ç”³è¯·å…¥é©»
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- ç®¡ç†é¤å“éƒ¨åˆ† -->
            <div id="meal-section" class="content-section" style="display: none;">
                <div class="content-card">
                    <div class="card-header">
                        <h2 class="card-title">é¤å“ç®¡ç†</h2>
                        <button class="btn" id="add-meal-btn">æ·»åŠ é¤å“</button>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>é¤å“åç§°</th>
                                    <th>ä»·æ ¼</th>
                                    <th>ç±»å‹</th>
                                    <th>å¹³å°</th>
                                    <th>æ·»åŠ æ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="meals-table-body">
                                {% for meal in meals %}
                                <tr>
                                    <td>{{ meal.name }}</td>
                                    <td>Â¥{{ meal.price }}</td>
                                    <td>{{ meal.get_meal_type_display }}</td>
                                    <td>{{ meal.platform.platform_name }}</td>
                                    <td>{{ meal.created_at|date:"Y-m-d H:i" }}</td>
                                    <td>
                                        <button class="btn btn-secondary edit-meal-btn"
                                                data-meal-id="{{ meal.id }}"
                                                style="padding: 4px 8px; margin-right: 5px;">
                                            ç¼–è¾‘
                                        </button>
                                        <button class="btn btn-secondary delete-meal-btn"
                                                data-meal-id="{{ meal.id }}"
                                                style="padding: 4px 8px; background-color: rgba(248, 81, 73, 0.1); color: #f85149; border-color: #f85149;">
                                            åˆ é™¤
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" style="text-align: center;">æš‚æ— é¤å“ï¼Œè¯·æ·»åŠ </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ç®¡ç†æŠ˜æ‰£éƒ¨åˆ† -->
            <div id="discount-section" class="content-section" style="display: none;">
                <div class="content-card">
                    <div class="card-header">
                        <h2 class="card-title">å¹³å°æŠ˜æ‰£ç®¡ç†</h2>
                        <button class="btn" id="set-discount-btn">è®¾ç½®æŠ˜æ‰£</button>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>å¹³å°åç§°</th>
                                    <th>å½“å‰æŠ˜æ‰£</th>
                                    <th>æœ€åæ›´æ–°æ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="discounts-table-body">
                                {% for discount in platform_discounts %}
                                <tr>
                                    <td>{{ discount.platform.platform_name }}</td>
                                    <td>{{ discount.discount.discount_rate }}%</td>
                                    <td>{{ discount.updated_at|date:"Y-m-d H:i" }}</td>
                                    <td>
                                        <button class="btn btn-secondary edit-discount-btn"
                                                data-discount-id="{{ discount.id }}"
                                                data-platform-id="{{ discount.platform.id }}"
                                                data-discount-rate="{{ discount.discount.discount_rate }}"
                                                style="padding: 4px 8px; margin-right: 5px;">
                                            ä¿®æ”¹
                                        </button>
                                        <button class="btn btn-secondary delete-discount-btn"
                                                data-discount-id="{{ discount.id }}"
                                                style="padding: 4px 8px; background-color: rgba(248, 81, 73, 0.1); color: #f85149; border-color: #f85149;">
                                            åˆ é™¤
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" style="text-align: center;">æš‚æ— æŠ˜æ‰£è®¾ç½®</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ç®¡ç†è®¢å•éƒ¨åˆ† -->
            <div id="order-section" class="content-section" style="display: none;">
                <div class="content-card">
                    <div class="card-header">
                        <h2 class="card-title">è®¢å•ç®¡ç†</h2>
                        <div class="filter-buttons">
                            <button class="btn btn-secondary filter-btn active" data-status="all">å…¨éƒ¨</button>
                            <button class="btn btn-secondary filter-btn" data-status="unassigned">æœªåˆ†é…éª‘æ‰‹</button>
                            <button class="btn btn-secondary filter-btn" data-status="assigned">å·²åˆ†é…éª‘æ‰‹</button>
                            <button class="btn btn-secondary filter-btn" data-status="ready">é¡¾å®¢å¾…å–é¤</button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>è®¢å•å·</th>
                                    <th>é¡¾å®¢</th>
                                    <th>å¹³å°</th>
                                    <th>é¤å“</th>
                                    <th>ä»·æ ¼</th>
                                    <th>éª‘æ‰‹</th>
                                    <th>çŠ¶æ€</th>
                                    <th>åˆ›å»ºæ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="orders-table-body">
                                {% for order in orders %}
                                <tr data-status="{{ order.status }}">
                                    <td>#{{ order.id }}</td>
                                    <td>{{ order.customer.customer_name }}</td>
                                    <td>{{ order.platform.platform_name }}</td>
                                    <td>{{ order.meal_summary }}</td>
                                    <td>Â¥{{ order.price }}</td>
                                    <td>
                                        {% if order.rider %}
                                            {{ order.rider.rider_name }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if order.status == 'unassigned' %}
                                            <span class="status-badge status-unassigned">æœªåˆ†é…éª‘æ‰‹</span>
                                        {% elif order.status == 'assigned' %}
                                            <span class="status-badge status-assigned">å·²åˆ†é…éª‘æ‰‹</span>
                                        {% elif order.status == 'ready' %}
                                            <span class="status-badge status-ready">é¡¾å®¢å¾…å–é¤</span>
                                        {% elif order.status == 'completed' %}
                                            <span class="status-badge status-completed">å·²å®Œæˆ</span>
                                        {% elif order.status == 'cancelled' %}
                                            <span class="status-badge status-cancelled">å·²å–æ¶ˆ</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ order.created_at|date:"Y-m-d H:i" }}</td>
                                    <td>
                                        <div class="order-actions">
                                            {% if order.status == 'unassigned' %}
                                                <button class="btn delete-order-btn"
                                                        data-order-id="{{ order.id }}"
                                                    data-order-info="è®¢å• #{{ order.id }} - {{ order.meal_summary }}">
                                                    åˆ é™¤
                                                </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="9" style="text-align: center;">æš‚æ— è®¢å•</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ é¤å“æ¨¡æ€æ¡† -->
    <div id="add-meal-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">æ·»åŠ æ–°é¤å“</h3>
                <button class="close-btn">&times;</button>
            </div>
            <form id="add-meal-form">
                {% csrf_token %}
                <div class="form-group">
                    <label for="platform-id">é€‰æ‹©å¹³å°</label>
                    <select id="platform-id" name="platform-id" required>
                        <option value="">è¯·é€‰æ‹©å¹³å°</option>
                        {% for platform in joined_platforms %}
                        <option value="{{ platform.id }}">{{ platform.platform_name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="meal-name">é¤å“åç§°</label>
                    <input type="text" id="meal-name" name="meal-name" required>
                </div>

                <div class="form-group">
                    <label for="meal-price">ä»·æ ¼</label>
                    <input type="number" id="meal-price" name="meal-price" min="0" step="0.01" required>
                </div>

                <div class="form-group">
                    <label for="meal-type">é¤å“ç±»å‹</label>
                    <select id="meal-type" name="meal-type" required>
                        <option value="">è¯·é€‰æ‹©ç±»å‹</option>
                        <option value="breakfast">æ—©é¤</option>
                        <option value="lunch">åˆé¤</option>
                        <option value="dinner">æ™šé¤</option>
                        <option value="lunch_and_dinner">åˆé¤å’Œæ™šé¤</option>
                    </select>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancel-meal-btn">å–æ¶ˆ</button>
                    <button type="submit" class="btn">æ·»åŠ é¤å“</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ç¼–è¾‘é¤å“æ¨¡æ€æ¡† -->
    <div id="edit-meal-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ç¼–è¾‘é¤å“</h3>
                <button class="close-btn">&times;</button>
            </div>
            <form id="edit-meal-form">
                {% csrf_token %}
                <input type="hidden" id="edit-meal-id" name="meal-id">

                <div class="form-group">
                    <label for="edit-meal-platform-id">é€‰æ‹©å¹³å°</label>
                    <select id="edit-meal-platform-id" name="platform-id" required>
                        <option value="">è¯·é€‰æ‹©å¹³å°</option>
                        {% for platform in joined_platforms %}
                        <option value="{{ platform.id }}">{{ platform.platform_name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="edit-meal-name">é¤å“åç§°</label>
                    <input type="text" id="edit-meal-name" name="meal-name" required>
                </div>

                <div class="form-group">
                    <label for="edit-meal-price">ä»·æ ¼</label>
                    <input type="number" id="edit-meal-price" name="meal-price" min="0" step="0.01" required>
                </div>

                <div class="form-group">
                    <label for="edit-meal-type">é¤å“ç±»å‹</label>
                    <select id="edit-meal-type" name="meal-type" required>
                        <option value="">è¯·é€‰æ‹©ç±»å‹</option>
                        <option value="breakfast">æ—©é¤</option>
                        <option value="lunch">åˆé¤</option>
                        <option value="dinner">æ™šé¤</option>
                        <option value="lunch_and_dinner">åˆé¤å’Œæ™šé¤</option>
                    </select>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancel-edit-meal-btn">å–æ¶ˆ</button>
                    <button type="submit" class="btn">æ›´æ–°é¤å“</button>
                </div>
            </form>
        </div>
    </div>

    <!-- è®¾ç½®æŠ˜æ‰£æ¨¡æ€æ¡† -->
    <div id="set-discount-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">è®¾ç½®å¹³å°æŠ˜æ‰£</h3>
                <button class="close-btn">&times;</button>
            </div>
            <form id="set-discount-form">
                {% csrf_token %}
                <div class="form-group">
                    <label for="discount-platform-id">é€‰æ‹©å¹³å°</label>
                    <select id="discount-platform-id" name="platform-id" required>
                        <option value="">è¯·é€‰æ‹©å¹³å°</option>
                        {% for platform in joined_platforms %}
                        <option value="{{ platform.id }}">{{ platform.platform_name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="discount-id">é€‰æ‹©æŠ˜æ‰£</label>
                    <select id="discount-id" name="discount-id" required>
                        <option value="">è¯·é€‰æ‹©æŠ˜æ‰£</option>
                        {% for discount in available_discounts %}
                        <option value="{{ discount.id }}">{{ discount.discount_rate }}% æŠ˜æ‰£</option>
                        {% endfor %}
                    </select>
                    <small style="color: #8b949e; font-size: 12px;">è¯·ä»é¢„ç½®æŠ˜æ‰£ä¸­é€‰æ‹©</small>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancel-discount-btn">å–æ¶ˆ</button>
                    <button type="submit" class="btn">è®¾ç½®æŠ˜æ‰£</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ç¼–è¾‘æŠ˜æ‰£æ¨¡æ€æ¡† -->
    <div id="edit-discount-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ä¿®æ”¹æŠ˜æ‰£</h3>
                <button class="close-btn">&times;</button>
            </div>
            <form id="edit-discount-form">
                {% csrf_token %}
                <input type="hidden" id="edit-discount-id" name="discount-id">
                <input type="hidden" id="edit-discount-platform-id" name="platform-id">

                <div class="form-group">
                    <label for="edit-discount-platform-name">å¹³å°åç§°</label>
                    <input type="text" id="edit-discount-platform-name" readonly style="background-color: #21262d; color: #8b949e;">
                </div>

                <div class="form-group">
                    <label for="edit-discount-select">é€‰æ‹©æŠ˜æ‰£</label>
                    <select id="edit-discount-select" name="discount-id" required>
                        <option value="">è¯·é€‰æ‹©æŠ˜æ‰£</option>
                        {% for discount in available_discounts %}
                        <option value="{{ discount.id }}">{{ discount.discount_rate }}% æŠ˜æ‰£</option>
                        {% endfor %}
                    </select>
                    <small style="color: #8b949e; font-size: 12px;">è¯·ä»é¢„ç½®æŠ˜æ‰£ä¸­é€‰æ‹©</small>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancel-edit-discount-btn">å–æ¶ˆ</button>
                    <button type="submit" class="btn">æ›´æ–°æŠ˜æ‰£</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // å¯¼èˆªèœå•åˆ‡æ¢
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();

                // æ›´æ–°æ´»åŠ¨èœå•é¡¹
                document.querySelectorAll('.nav-link').forEach(item => {
                    item.classList.remove('active');
                });
                this.classList.add('active');

                // æ˜¾ç¤ºå¯¹åº”çš„å†…å®¹åŒºåŸŸ
                const targetId = this.getAttribute('data-target');
                document.querySelectorAll('.content-section').forEach(section => {
                    section.style.display = 'none';
                });
                document.getElementById(targetId).style.display = 'block';
            });
        });

        // è®¢å•çŠ¶æ€ç­›é€‰
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const status = this.getAttribute('data-status');

                // æ›´æ–°æ´»åŠ¨ç­›é€‰æŒ‰é’®
                document.querySelectorAll('.filter-btn').forEach(b => {
                    b.classList.remove('active');
                });
                this.classList.add('active');

                // ç­›é€‰è®¢å•
                const rows = document.querySelectorAll('#orders-table-body tr');
                rows.forEach(row => {
                    if (status === 'all' || row.getAttribute('data-status') === status) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        });

        // åˆ é™¤è®¢å•åŠŸèƒ½
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('delete-order-btn')) {
                const orderId = e.target.getAttribute('data-order-id');
                const orderInfo = e.target.getAttribute('data-order-info');

                if (confirm(`ç¡®å®šè¦åˆ é™¤ ${orderInfo} å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
                    deleteOrder(orderId);
                }
            }
        });

        // åˆ é™¤è®¢å•å‡½æ•°
        function deleteOrder(orderId) {
            // è·å– CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            // å‘é€ AJAX è¯·æ±‚
            fetch(`/merchant/delete-order/${orderId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('è®¢å•åˆ é™¤æˆåŠŸï¼');
                    updateOrdersTable();
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            });
        }

        // æ›´æ–°è®¢å•è¡¨æ ¼
        function updateOrdersTable() {
            // è·å– CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            // å‘é€ AJAX è¯·æ±‚è·å–æœ€æ–°çš„è®¢å•æ•°æ®
            fetch('/merchant/get-orders/', {
                method: 'GET',
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const tableBody = document.getElementById('orders-table-body');
                    tableBody.innerHTML = '';

                    if (data.orders.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center;">æš‚æ— è®¢å•</td></tr>';
                    } else {
                        data.orders.forEach(order => {
                            const row = document.createElement('tr');
                            row.setAttribute('data-status', order.status);

                            // è·å–çŠ¶æ€æ˜¾ç¤ºæ–‡æœ¬
                            const statusText = getStatusText(order.status);

                            row.innerHTML = `
                                <td>#${order.id}</td>
                                <td>${order.customer_name}</td>
                                <td>${order.platform_name}</td>
                                <td>${order.meal_summary || 'â€”'}</td>
                                <td>Â¥${order.price}</td>
                                <td>${order.rider_name || '-'}</td>
                                <td>
                                    <span class="status-badge status-${order.status}">${statusText}</span>
                                </td>
                                <td>${order.created_at}</td>
                                <td>
                                    <div class="order-actions">
                                        ${order.status === 'unassigned' ?
                                            `<button class="btn delete-order-btn"
                                                    data-order-id="${order.id}"
                                                    data-order-info="è®¢å• #${order.id} - ${order.meal_summary || ''}">
                                                åˆ é™¤
                                            </button>` : ''}
                                    </div>
                                </td>
                            `;
                            tableBody.appendChild(row);
                        });
                    }
                } else {
                    alert('è·å–è®¢å•æ•°æ®å¤±è´¥: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            });
        }

        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            const statusMap = {
                'unassigned': 'æœªåˆ†é…éª‘æ‰‹',
                'assigned': 'å·²åˆ†é…éª‘æ‰‹',
                'ready': 'é¡¾å®¢å¾…å–é¤',
                'completed': 'å·²å®Œæˆ',
                'cancelled': 'å·²å–æ¶ˆ'
            };
            return statusMap[status] || status;
        }

        // é€€å‡ºç™»å½•
        document.querySelector('.logout-btn').addEventListener('click', function() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                window.location.href = '/login/';
            }
        });

        // å¹³å°å…¥é©»ç”³è¯·
        document.querySelectorAll('.join-platform-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const platformId = this.getAttribute('data-platform-id');
                const platformName = this.closest('.platform-card').querySelector('.platform-name').textContent;

                if (confirm(`ç¡®å®šè¦ç”³è¯·å…¥é©» ${platformName} å—ï¼Ÿ`)) {
                    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                    const originalText = this.textContent;
                    this.textContent = 'ç”³è¯·ä¸­...';
                    this.disabled = true;

                    // è·å– CSRF token
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                    // å‘é€ AJAX è¯·æ±‚
                    fetch('/merchant/apply-platform/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': csrfToken
                        },
                        body: new URLSearchParams({
                            'platform_id': platformId
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(data.message);
                            location.reload();
                        } else {
                            alert(data.message);
                            this.textContent = originalText;
                            this.disabled = false;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
                        this.textContent = originalText;
                        this.disabled = false;
                    });
                }
            });
        });

        // åŸæœ‰çš„é¤å“å’ŒæŠ˜æ‰£ç®¡ç†ä»£ç ä¿æŒä¸å˜...
        // [æ­¤å¤„ä¿ç•™åŸæœ‰çš„é¤å“å’ŒæŠ˜æ‰£ç®¡ç†JavaScriptä»£ç ]
        // æ·»åŠ é¤å“æ¨¡æ€æ¡†
        const addMealBtn = document.getElementById('add-meal-btn');
        const addMealModal = document.getElementById('add-meal-modal');
        const closeModalBtn = document.querySelector('.close-btn');
        const cancelMealBtn = document.getElementById('cancel-meal-btn');
        const addMealForm = document.getElementById('add-meal-form');

        addMealBtn.addEventListener('click', function() {
            addMealModal.style.display = 'flex';
        });

        closeModalBtn.addEventListener('click', function() {
            addMealModal.style.display = 'none';
        });

        cancelMealBtn.addEventListener('click', function() {
            addMealModal.style.display = 'none';
        });

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.addEventListener('click', function(e) {
            if (e.target === addMealModal) {
                addMealModal.style.display = 'none';
            }
        });

        // æ·»åŠ é¤å“è¡¨å•æäº¤
        addMealForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const platformId = document.getElementById('platform-id').value;
            const mealName = document.getElementById('meal-name').value;
            const mealPrice = document.getElementById('meal-price').value;
            const mealType = document.getElementById('meal-type').value;

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const submitBtn = addMealForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'æ·»åŠ ä¸­...';
            submitBtn.disabled = true;

            // è·å– CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            // å‘é€ AJAX è¯·æ±‚
            fetch('/merchant/add-meal/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken
                },
                body: new URLSearchParams({
                    'platform-id': platformId,
                    'meal-name': mealName,
                    'meal-price': mealPrice,
                    'meal-type': mealType
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('ç½‘ç»œå“åº”ä¸æ­£å¸¸');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // æ·»åŠ æˆåŠŸ
                    alert('é¤å“æ·»åŠ æˆåŠŸï¼');
                    addMealModal.style.display = 'none';
                    addMealForm.reset();

                    // ä¸åˆ·æ–°é¡µé¢ï¼Œè€Œæ˜¯åŠ¨æ€æ›´æ–°é¤å“è¡¨æ ¼
                    updateMealsTable();
                } else {
                    // æ·»åŠ å¤±è´¥
                    alert('æ·»åŠ å¤±è´¥: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•: ' + error.message);
            })
            .finally(() => {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            });
        });

        // ç¼–è¾‘é¤å“åŠŸèƒ½
        const editMealModal = document.getElementById('edit-meal-modal');
        const editMealForm = document.getElementById('edit-meal-form');
        const cancelEditMealBtn = document.getElementById('cancel-edit-meal-btn');

        // ç¼–è¾‘æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('edit-meal-btn')) {
                const mealId = e.target.getAttribute('data-meal-id');
                openEditModal(mealId);
            }

            if (e.target.classList.contains('delete-meal-btn')) {
                const mealId = e.target.getAttribute('data-meal-id');
                deleteMeal(mealId);
            }
        });

        // æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
        function openEditModal(mealId) {
            // è·å–å½“å‰è¡Œçš„æ•°æ®
            const row = document.querySelector(`[data-meal-id="${mealId}"]`).closest('tr');
            const name = row.cells[0].textContent;
            const price = row.cells[1].textContent.replace('Â¥', '');
            const typeText = row.cells[2].textContent;
            const platformName = row.cells[3].textContent;

            // å°†ä¸­æ–‡ç±»å‹è½¬æ¢ä¸ºå€¼
            let typeValue = '';
            switch(typeText) {
                case 'æ—©é¤': typeValue = 'breakfast'; break;
                case 'åˆé¤': typeValue = 'lunch'; break;
                case 'æ™šé¤': typeValue = 'dinner'; break;
                case 'åˆé¤å’Œæ™šé¤': typeValue = 'lunch_and_dinner'; break;
            }

            // å¡«å……è¡¨å•
            document.getElementById('edit-meal-id').value = mealId;
            document.getElementById('edit-meal-name').value = name;
            document.getElementById('edit-meal-price').value = price;
            document.getElementById('edit-meal-type').value = typeValue;

            // è®¾ç½®å¹³å°é€‰æ‹©
            const platformSelect = document.getElementById('edit-meal-platform-id');
            for (let i = 0; i < platformSelect.options.length; i++) {
                if (platformSelect.options[i].text === platformName) {
                    platformSelect.selectedIndex = i;
                    break;
                }
            }

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            editMealModal.style.display = 'flex';
        }

        // ç¼–è¾‘é¤å“æ¨¡æ€æ¡†å…³é—­æŒ‰é’®
        document.querySelector('#edit-meal-modal .close-btn').addEventListener('click', function() {
            editMealModal.style.display = 'none';
        });

        // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
        cancelEditMealBtn.addEventListener('click', function() {
            editMealModal.style.display = 'none';
        });

        // ç‚¹å‡»ç¼–è¾‘æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.addEventListener('click', function(e) {
            if (e.target === editMealModal) {
                editMealModal.style.display = 'none';
            }
        });

        // ç¼–è¾‘è¡¨å•æäº¤
        editMealForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const mealId = document.getElementById('edit-meal-id').value;
            const platformId = document.getElementById('edit-meal-platform-id').value;
            const mealName = document.getElementById('edit-meal-name').value;
            const mealPrice = document.getElementById('edit-meal-price').value;
            const mealType = document.getElementById('edit-meal-type').value;

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const submitBtn = editMealForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'æ›´æ–°ä¸­...';
            submitBtn.disabled = true;

            // è·å– CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            // å‘é€ AJAX è¯·æ±‚
            fetch(`/merchant/edit-meal/${mealId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken
                },
                body: new URLSearchParams({
                    'platform-id': platformId,
                    'meal-name': mealName,
                    'meal-price': mealPrice,
                    'meal-type': mealType
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('ç½‘ç»œå“åº”ä¸æ­£å¸¸');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // æ›´æ–°æˆåŠŸ
                    alert('é¤å“æ›´æ–°æˆåŠŸï¼');
                    editMealModal.style.display = 'none';
                    editMealForm.reset();

                    // ä¸åˆ·æ–°é¡µé¢ï¼Œè€Œæ˜¯åŠ¨æ€æ›´æ–°é¤å“è¡¨æ ¼
                    updateMealsTable();
                } else {
                    // æ›´æ–°å¤±è´¥
                    alert('æ›´æ–°å¤±è´¥: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•: ' + error.message);
            })
            .finally(() => {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            });
        });

        // åˆ é™¤é¤å“åŠŸèƒ½
        function deleteMeal(mealId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¤å“å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                return;
            }

            // è·å– CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            // å‘é€ AJAX è¯·æ±‚
            fetch(`/merchant/delete-meal/${mealId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('ç½‘ç»œå“åº”ä¸æ­£å¸¸');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // åˆ é™¤æˆåŠŸ
                    alert('é¤å“åˆ é™¤æˆåŠŸï¼');

                    // ä¸åˆ·æ–°é¡µé¢ï¼Œè€Œæ˜¯åŠ¨æ€æ›´æ–°é¤å“è¡¨æ ¼
                    updateMealsTable();
                } else {
                    // åˆ é™¤å¤±è´¥
                    alert('åˆ é™¤å¤±è´¥: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•: ' + error.message);
            });
        }

        // æ›´æ–°é¤å“è¡¨æ ¼çš„å‡½æ•°
        function updateMealsTable() {
            // è·å– CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            // å‘é€ AJAX è¯·æ±‚è·å–æœ€æ–°çš„é¤å“æ•°æ®
            fetch('/merchant/get-meals/', {
                method: 'GET',
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('ç½‘ç»œå“åº”ä¸æ­£å¸¸');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // æ›´æ–°è¡¨æ ¼å†…å®¹
                    const tableBody = document.getElementById('meals-table-body');
                    tableBody.innerHTML = '';

                    if (data.meals.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">æš‚æ— é¤å“ï¼Œè¯·æ·»åŠ </td></tr>';
                    } else {
                        data.meals.forEach(meal => {
                            const row = document.createElement('tr');

                            // å°†è‹±æ–‡ç±»å‹è½¬æ¢ä¸ºä¸­æ–‡æ˜¾ç¤º
                            let typeDisplay = '';
                            switch(meal.meal_type) {
                                case 'breakfast': typeDisplay = 'æ—©é¤'; break;
                                case 'lunch': typeDisplay = 'åˆé¤'; break;
                                case 'dinner': typeDisplay = 'æ™šé¤'; break;
                                case 'lunch_and_dinner': typeDisplay = 'åˆé¤å’Œæ™šé¤'; break;
                            }

                            row.innerHTML = `
                                <td>${meal.name}</td>
                                <td>Â¥${meal.price}</td>
                                <td>${typeDisplay}</td>
                                <td>${meal.platform_name}</td>
                                <td>${meal.created_at}</td>
                                <td>
                                    <button class="btn btn-secondary edit-meal-btn"
                                            data-meal-id="${meal.id}"
                                            style="padding: 4px 8px; margin-right: 5px;">
                                        ç¼–è¾‘
                                    </button>
                                    <button class="btn btn-secondary delete-meal-btn"
                                            data-meal-id="${meal.id}"
                                            style="padding: 4px 8px; background-color: rgba(248, 81, 73, 0.1); color: #f85149; border-color: #f85149;">
                                        åˆ é™¤
                                    </button>
                                </td>
                            `;
                            tableBody.appendChild(row);
                        });
                    }
                } else {
                    alert('è·å–é¤å“æ•°æ®å¤±è´¥: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•: ' + error.message);
            });
        }

        // æŠ˜æ‰£ç®¡ç†åŠŸèƒ½
        // è®¾ç½®æŠ˜æ‰£æ¨¡æ€æ¡†
        const setDiscountBtn = document.getElementById('set-discount-btn');
        const setDiscountModal = document.getElementById('set-discount-modal');
        const cancelDiscountBtn = document.getElementById('cancel-discount-btn');
        const setDiscountForm = document.getElementById('set-discount-form');

        setDiscountBtn.addEventListener('click', function() {
            setDiscountModal.style.display = 'flex';
        });

        cancelDiscountBtn.addEventListener('click', function() {
            setDiscountModal.style.display = 'none';
        });

        // ç¼–è¾‘æŠ˜æ‰£æ¨¡æ€æ¡†
        const editDiscountModal = document.getElementById('edit-discount-modal');
        const cancelEditDiscountBtn = document.getElementById('cancel-edit-discount-btn');
        const editDiscountForm = document.getElementById('edit-discount-form');

        // å…³é—­æŠ˜æ‰£æ¨¡æ€æ¡†
        document.querySelectorAll('.close-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                setDiscountModal.style.display = 'none';
                editDiscountModal.style.display = 'none';
            });
        });

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.addEventListener('click', function(e) {
            if (e.target === setDiscountModal) {
                setDiscountModal.style.display = 'none';
            }
            if (e.target === editDiscountModal) {
                editDiscountModal.style.display = 'none';
            }
        });

        // è®¾ç½®æŠ˜æ‰£è¡¨å•æäº¤
        setDiscountForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const platformId = document.getElementById('discount-platform-id').value;
            const discountId = document.getElementById('discount-id').value;

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const submitBtn = setDiscountForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'è®¾ç½®ä¸­...';
            submitBtn.disabled = true;

            // è·å– CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            // å‘é€ AJAX è¯·æ±‚
            fetch('/merchant/set-discount/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken
                },
                body: new URLSearchParams({
                    'platform-id': platformId,
                    'discount-id': discountId
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('ç½‘ç»œå“åº”ä¸æ­£å¸¸');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert('æŠ˜æ‰£è®¾ç½®æˆåŠŸï¼');
                    setDiscountModal.style.display = 'none';
                    setDiscountForm.reset();

                    // æ›´æ–°æŠ˜æ‰£è¡¨æ ¼
                    updateDiscountsTable();
                } else {
                    alert('è®¾ç½®å¤±è´¥: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•: ' + error.message);
            })
            .finally(() => {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            });
        });

        // ç¼–è¾‘æŠ˜æ‰£åŠŸèƒ½
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('edit-discount-btn')) {
                const discountId = e.target.getAttribute('data-discount-id');
                const platformId = e.target.getAttribute('data-platform-id');
                const currentDiscountId = e.target.getAttribute('data-current-discount-id');
                const currentDiscountRate = e.target.getAttribute('data-discount-rate');
                const platformName = e.target.closest('tr').cells[0].textContent;

                openEditDiscountModal(discountId, platformId, platformName, currentDiscountId, currentDiscountRate);
            }

            if (e.target.classList.contains('delete-discount-btn')) {
                const discountId = e.target.getAttribute('data-discount-id');
                deleteDiscount(discountId);
            }
        });

        // æ‰“å¼€ç¼–è¾‘æŠ˜æ‰£æ¨¡æ€æ¡†
        function openEditDiscountModal(discountId, platformId, platformName, currentDiscountId, currentDiscountRate) {
            document.getElementById('edit-discount-id').value = discountId;
            document.getElementById('edit-discount-platform-id').value = platformId;
            document.getElementById('edit-discount-platform-name').value = platformName;

            // è®¾ç½®å½“å‰é€‰ä¸­çš„æŠ˜æ‰£
            const discountSelect = document.getElementById('edit-discount-select');
            for (let i = 0; i < discountSelect.options.length; i++) {
                if (discountSelect.options[i].value === currentDiscountId) {
                    discountSelect.selectedIndex = i;
                    break;
                }
            }

            editDiscountModal.style.display = 'flex';
        }

        // ç¼–è¾‘æŠ˜æ‰£è¡¨å•æäº¤
        editDiscountForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const merchantDiscountId = document.getElementById('edit-discount-id').value;
            const discountId = document.getElementById('edit-discount-select').value;

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const submitBtn = editDiscountForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'æ›´æ–°ä¸­...';
            submitBtn.disabled = true;

            // è·å– CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            // å‘é€ AJAX è¯·æ±‚
            fetch(`/merchant/edit-discount/${merchantDiscountId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken
                },
                body: new URLSearchParams({
                    'discount-id': discountId
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('ç½‘ç»œå“åº”ä¸æ­£å¸¸');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert('æŠ˜æ‰£æ›´æ–°æˆåŠŸï¼');
                    editDiscountModal.style.display = 'none';
                    editDiscountForm.reset();

                    // æ›´æ–°æŠ˜æ‰£è¡¨æ ¼
                    updateDiscountsTable();
                } else {
                    alert('æ›´æ–°å¤±è´¥: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•: ' + error.message);
            })
            .finally(() => {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            });
        });

        // åˆ é™¤æŠ˜æ‰£åŠŸèƒ½
        function deleteDiscount(discountId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæŠ˜æ‰£è®¾ç½®å—ï¼Ÿ')) {
                return;
            }

            // è·å– CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            // å‘é€ AJAX è¯·æ±‚
            fetch(`/merchant/delete-discount/${discountId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('ç½‘ç»œå“åº”ä¸æ­£å¸¸');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert('æŠ˜æ‰£åˆ é™¤æˆåŠŸï¼');
                    updateDiscountsTable();
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•: ' + error.message);
            });
        }

        // æ›´æ–°æŠ˜æ‰£è¡¨æ ¼çš„å‡½æ•°
        function updateDiscountsTable() {
            // è·å– CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            // å‘é€ AJAX è¯·æ±‚è·å–æœ€æ–°çš„æŠ˜æ‰£æ•°æ®
            fetch('/merchant/get-discounts/', {
                method: 'GET',
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('ç½‘ç»œå“åº”ä¸æ­£å¸¸');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    const tableBody = document.getElementById('discounts-table-body');
                    tableBody.innerHTML = '';

                    if (data.discounts.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">æš‚æ— æŠ˜æ‰£è®¾ç½®</td></tr>';
                    } else {
                        data.discounts.forEach(discount => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${discount.platform_name}</td>
                                <td>${discount.discount_rate}%</td>
                                <td>${discount.updated_at}</td>
                                <td>
                                    <button class="btn btn-secondary edit-discount-btn"
                                            data-discount-id="${discount.id}"
                                            data-platform-id="${discount.platform_id}"
                                            data-current-discount-id="${discount.discount_id}"
                                            data-discount-rate="${discount.discount_rate}"
                                            style="padding: 4px 8px; margin-right: 5px;">
                                        ä¿®æ”¹
                                    </button>
                                    <button class="btn btn-secondary delete-discount-btn"
                                            data-discount-id="${discount.id}"
                                            style="padding: 4px 8px; background-color: rgba(248, 81, 73, 0.1); color: #f85149; border-color: #f85149;">
                                        åˆ é™¤
                                    </button>
                                </td>
                            `;
                            tableBody.appendChild(row);
                        });
                    }
                } else {
                    alert('è·å–æŠ˜æ‰£æ•°æ®å¤±è´¥: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•: ' + error.message);
            });
        }

        // è®¢å•ç­›é€‰
        document.getElementById('filter-assigned').addEventListener('click', function() {
            alert('æ˜¾ç¤ºå·²åˆ†é…è®¢å•');
        });

        document.getElementById('filter-unassigned').addEventListener('click', function() {
            alert('æ˜¾ç¤ºæœªåˆ†é…è®¢å•');
        });

        document.getElementById('filter-all').addEventListener('click', function() {
            alert('æ˜¾ç¤ºæ‰€æœ‰è®¢å•');
        });

        // é€€å‡ºç™»å½•
        document.querySelector('.logout-btn').addEventListener('click', function() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                window.location.href = '/login/';
            }
        });

        // å¹³å°å…¥é©»ç”³è¯·
        document.querySelectorAll('.platform-card:not(.joined):not(.applied) .btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const platformId = this.getAttribute('data-platform-id');
                const platformName = this.closest('.platform-card').querySelector('.platform-name').textContent;

                if (confirm(`ç¡®å®šè¦ç”³è¯·å…¥é©» ${platformName} å—ï¼Ÿ`)) {
                    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                    const originalText = this.textContent;
                    this.textContent = 'ç”³è¯·ä¸­...';
                    this.disabled = true;

                    // è·å– CSRF token
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                    // å‘é€ AJAX è¯·æ±‚
                    fetch('/merchant/apply-platform/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': csrfToken
                        },
                        body: new URLSearchParams({
                            'platform_id': platformId
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(data.message);
                            // åˆ·æ–°é¡µé¢
                            location.reload();
                        } else {
                            alert(data.message);
                            // æ¢å¤æŒ‰é’®çŠ¶æ€
                            this.textContent = originalText;
                            this.disabled = false;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
                        // æ¢å¤æŒ‰é’®çŠ¶æ€
                        this.textContent = originalText;
                        this.disabled = false;
                    });
                }
            });
        });

    </script>
</body>
</html>
